name: Deploy Dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_REGISTRY: ghcr.io

jobs:
  # 메타데이터 추출 (공통)
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      owner: ${{ steps.meta.outputs.owner }}
      image_prefix: ${{ steps.meta.outputs.image_prefix }}
      sha_short: ${{ steps.meta.outputs.sha_short }}
    steps:
      - name: Extract metadata
        id: meta
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=${OWNER_LC}" >> $GITHUB_OUTPUT
          echo "image_prefix=${OWNER_LC}/swim-scheduler" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

  # 병렬 빌드
  build-parser:
    name: Build Parser
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./services/parser
          file: ./services/parser/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-parser:latest
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-parser:${{ needs.prepare.outputs.sha_short }}
          cache-from: type=gha,scope=parser
          cache-to: type=gha,mode=max,scope=parser

  build-api:
    name: Build API
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./services
          file: ./services/api/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-api:latest
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-api:${{ needs.prepare.outputs.sha_short }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

  build-frontend:
    name: Build Frontend
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./services/frontend
          file: ./services/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-frontend:latest
            ${{ env.DOCKER_REGISTRY }}/${{ needs.prepare.outputs.image_prefix }}-frontend:${{ needs.prepare.outputs.sha_short }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  deploy:
    name: Deploy to Server
    needs: [prepare, build-parser, build-api, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/swim-scheduler/services/db"
          scp -i ~/.ssh/id_rsa docker-compose.dev.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/swim-scheduler/docker-compose.yml
          scp -i ~/.ssh/id_rsa -r monitoring ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/swim-scheduler/
          scp -i ~/.ssh/id_rsa services/db/init.sql ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/swim-scheduler/services/db/

      - name: Create .env file
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            cat > ~/swim-scheduler/.env << 'ENVFILE'
          GITHUB_REPOSITORY_OWNER=${{ needs.prepare.outputs.owner }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          DB_USER=swim_app
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=swim_dev
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          GRAFANA_USER=admin
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
          ENVFILE
            chmod 600 ~/swim-scheduler/.env
          EOF

      - name: Deploy
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            cd ~/swim-scheduler

            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 이미지 pull 및 재시작
            docker compose pull
            docker compose up -d --remove-orphans

            # 오래된 이미지 정리
            docker image prune -af

            docker compose ps
            echo "✅ 배포 완료!"
          EOF

      - name: Health check
        run: |
          echo "API 시작 대기 중..."
          sleep 10

          for i in {1..6}; do
            echo "Health check 시도 $i/6..."
            if curl -sf http://${{ secrets.SSH_HOST }}:80/health; then
              echo ""
              echo "✅ Health check 통과"
              exit 0
            fi
            [ $i -lt 6 ] && sleep 10
          done

          echo "❌ Health check 실패"
          exit 1
